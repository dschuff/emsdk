name: Create release tag

on:
  push:
    paths: [ emscripten-releases-tags.json, .github/workflows/tag-release.yml ]
  workflow_dispatch:

jobs:
    tag-release:
      if: github.event.head_commit.author.username == 'github-actions[bot]'
      runs-on: ubuntu-latest
      steps:
        - name: Get Release number
          uses: actions/github-script@v7
          with:
            script: |
              console.log('${{ github.event.head_commit.author.username }}')
              console.log('${{ github.event.head_commit.committer.username }}')
              console.log(context.sha)
              //console.log('${{github.env.head_commit}}')
              const commit = await github.rest.git.getCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha
              })
              console.log(commit)
              console.log(commit.data.author)
              const message = `${{ github.event.head_commit.message }}`
              console.log('message')
              console.log(message)
              const regex = /Release ([0-9]+.[0-9]+.[0-9]+)/
              const match = message.match(regex)
              if (match) {
                const release = match[1]
                console.log(`Matched release ${release}`)
              } else {
               console.log("no match")
              }
        - name: Create tag
          uses: actions/github-script@v7
          with:
            script: |
              const message = `${{ github.event.head_commit.message }}`
              const regex = /Release ([0-9]+.[0-9]+.[0-9]+)/
              const match = message.match(regex)
              if (match) {
                const release = match[1]
                console.log(`Matched release ${release}`)
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/tags/${release}`,
                  sha: context.sha
                })
              } else {
               console.log(`Commit message: ${message} did not match`)
              }

      
